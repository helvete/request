#!/usr/bin/env php
<?php
$time = -microtime(true);

define('SCRIPT_VERSION', '0.28');
define('FILE', 'C1cHmKNQr1f7gB2YXr7w');
define('OPT_X', 'x');
define('OPT_N', 'n');
define('OPT_H', 'h');
define('OPT_L', 'l');

include __DIR__ . "/ApiRequester/Client.php";

$options = _processParams();
if ($options[OPT_H]) {
	_printHelp();
	exit(0);
}

$r = new helvete\ApiRequester\Client($options[FILE]);
$request = $r->setFollowRedirect(!$options[OPT_L])->request();
$httpCode = key($request);
$response = current($request);
$key = "<-- [{$httpCode}]";
$iterate = array(
	"--> {$r->getMethod()} [{$r->getUrl()}]" => $r->getReqStr(),
	$key => $response,
);

if ($options[OPT_X]) {
	echo $iterate[$key];
	exit(0);
}

$embed = '';
foreach ($iterate as $name => $data) {
	echo "{$embed}{$name}:\n";
	if ($options[OPT_N]) {
		echo $data;
	} else {
        if (empty($data)) {
            $embed = "";
            continue;
        }
		print_r(
			json_encode(
				json_decode($data, true),
				JSON_PRETTY_PRINT|JSON_UNESCAPED_SLASHES
			)
		);
	}
	$embed = "\n";
}
$time += microtime(true);
$time = number_format($time, 2);
echo "\nBye! (Request duration: {$time}s)\n";

/******************************************************************************/

/**
 * Proces runtime parameters and return them in a nicely readable way
 *
 * @return array
 */
function _processParams() {
	global $argv;
	$provided = array(
		OPT_X => false,
		OPT_N => false,
		OPT_H => false,
		OPT_L => false,
	);
	for ($i = 1; $i < count($argv); $i++) {
		switch ($argv[$i]) {
		case '-x':
		case '--exact-response':
			$provided[OPT_X] = true;
			break;
		case '-nx':
		case '-xn':
			$provided[OPT_X] = true;
		case '-n':
		case '--non-json':
			$provided[OPT_N] = true;
			break;
		case '-h':
		case '--help':
			$provided[OPT_H] = true;
			break;
		case '-l':
		case '--no-follow-redirect':
			$provided[OPT_L] = true;
			break;
		default:
			if (!file_exists($argv[$i])) {
				echo "Unknown runtime param {$argv[$i]}\n";
				exit(2);
			}
			$provided[FILE] = $argv[$i];
		}
	}

	return $provided;
}


/**
 * Print help message
 *
 * @return void
 */
function _printHelp() {
	global $argv;
	$scriptVer = SCRIPT_VERSION;
	$libVer = \helvete\ApiRequester\Client::LIB_VERSION;
	$self = $argv[0];
	echo <<<TXT
Request remote APIs utility.
	Library version: $libVer
	Script version: $scriptVer
Usage:
	$self [-h|--help] [-n|--non-json] [-x|--exact-response]
		[-l|--no-follow-redirect] <options file>
Parameters:
	-h|--help
		Print this help
	-n|--non-json
		Script will not expect JSON response payload and will not attempt to
		format it on standard out
	-x|--exact-response
		Response will not be formated. Only the actual response is printed.
		Useful for commands chaining
	-l|--no-follow-redirects
		Default behaviour is to follow any location redirects. Provide this flag
		in order for the client not to follow redirects
	<options-file>
		Provided location of options file. See ./post-request-example for clues
Note:
	Short versions of -x and -n parameters can be combined like -xn or -nx.

TXT;
}
